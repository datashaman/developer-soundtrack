## Codebase Patterns
- Package manager: pnpm (not npm/yarn)
- File structure: src/app/, src/lib/, src/components/, src/hooks/, src/types/
- Path alias: `@/*` maps to `./src/*`
- TypeScript strict mode is enabled
- Tailwind CSS v4 with `@tailwindcss/postcss` plugin
- Next.js 16 with App Router
- Node.js v24 LTS required
- Database files go in `data/` directory (gitignored)
- `.env.example` is tracked (excluded from `.env*` gitignore pattern)
- Test runner: Vitest with `pnpm test` (vitest run), config in `vitest.config.ts`
- Typecheck: `pnpm typecheck` (tsc --noEmit)
- Tests go in `*.test.ts` files next to the source files
- Utility modules go in `src/lib/utils/` (hash.ts, etc.)
- djb2 hash function used for deterministic string → number mapping (no external deps)
- Mocking Tone.js: use `function MockX() { this.prop = ... }` constructors, not arrow functions — `new` requires proper constructors
- React hook tests: use `@testing-library/react` with `renderHook`/`act`, set `// @vitest-environment jsdom` comment at top of `.test.tsx` file
- Dev deps for hook testing: `@testing-library/react`, `jsdom`
- Component tests with `// @vitest-environment jsdom`: add explicit `cleanup()` in `afterEach` to prevent DOM accumulation across tests
- DB tests: use `vi.mock("./index")` to inject test db
- JSON columns (languages, musical_params, etc.) stored as TEXT, parsed with JSON.parse/JSON.stringify
- Auth: NextAuth.js v5 beta — config in `src/lib/auth.ts`, route at `src/app/api/auth/[...nextauth]/route.ts`
- Auth: `Providers` wrapper (`SessionProvider`) in `src/components/shared/Providers.tsx`, used in root layout
- Auth: Type augmentation for session `accessToken` in `src/types/next-auth.d.ts`
- Animation loops: use `drawRef` pattern (store callback in ref) to avoid self-referencing `useCallback` lint errors
- GitHub integration modules go in `src/lib/github/` (languages.ts, client.ts, commits.ts, etc.)
- Language names must exactly match keys in `LANGUAGE_SYNTH_MAP` from `src/lib/music/synths.ts`
- Commit caching: API routes should call `getCachedCommits()` from `src/lib/github/cache.ts` — it checks SQLite first, fetches from GitHub on miss/stale
- API route auth pattern: call `auth()` from `@/lib/auth`, check `session?.accessToken`, return 401 if missing
- API route test mocking for `auth()`: use separate `vi.fn<() => Promise<Session | null>>()` wired through mock factory to avoid NextAuth overloaded type issues
- React `react-hooks/refs` lint rule: cannot assign `ref.current = value` during render — use `useEffect` to sync state to refs
- Shared UI components in `src/components/shared/`: `LanguageIcon`, `CIBadge`, `DiffStats` — use these instead of inline implementations
- `LANGUAGE_COLORS` single source of truth: import from `@/components/shared/LanguageIcon` — never duplicate the color map
- Responsive breakpoints: mobile (<768px / `md:`), tablet (768-1024px / `lg:`), desktop (>1024px). Use `min-h-11` (44px) for touch targets on mobile
- Three-breakpoint visibility: `hidden lg:block` (desktop-only), `hidden md:block lg:hidden` (tablet-only), `block md:hidden` (mobile-only)
- Database: `@libsql/client` (Turso-compatible), async API; db modules in `src/lib/db/`
- Live mode: Pusher for real-time events — server in `src/lib/pusher/server.ts`, client in `src/lib/pusher/client.ts`
- Pusher channel naming: `repo-${owner}-${repoName}` — events: `commits` (array of Commit objects)
- Pusher test mocking: mock `@/lib/pusher/client` with factory returning subscribe/unsubscribe/connection; wrap _emit calls in `act()`
- Rate limit flow: `fetchCommits` → `getCachedCommits` → API route → `useCommits` → player UI (null when served from cache)
- Error retry pattern: `useCommits` exposes `retry()` — RepoSelector uses `useCallback` + `fetchRepos()` for retry
- React state accumulation pattern: to accumulate values from a changing prop/hook value, use "adjust state during render" with `useState` for previous-value tracking (not refs) — avoids `react-hooks/set-state-in-effect` and `react-hooks/refs` lint errors
- Settings components go in `src/components/settings/` — presentational components that take state props and onChange callbacks
- `enabledLanguages` semantics: empty `[]` = all enabled (default), non-empty = explicit list — consistent across DB, API, engine, and UI
- MusicEngine `setEnabledLanguages()` controls which languages play — `scheduleNext()` skips disabled languages automatically
- Known authors API: `GET /api/authors` returns distinct authors from commits table — requires at least one repo to have been played/cached

---

## 2026-02-22 - US-001
- Scaffolded project with Next.js 16, TypeScript, Tailwind CSS v4, pnpm
- Moved `app/` to `src/app/`, created `src/lib/`, `src/components/`, `src/hooks/`, `src/types/`
- Added `.nvmrc` (v24) and `engines` field in package.json
- Created `.env.example` with GitHub OAuth, NextAuth, and Database vars
- Created `data/` directory with `.gitkeep`, gitignored `*.db` files
- Updated tsconfig `@/*` path alias to point to `./src/*`
- Files changed: .gitignore, package.json, tsconfig.json, .nvmrc, .env.example, data/.gitkeep, src/app/* (moved from app/)
- **Learnings for future iterations:**
  - Project was bootstrapped with Next.js 16 (not 14), uses App Router
  - `.gitignore` has `.env*` pattern — need `!.env.example` to track .env.example
  - TypeScript strict mode was already enabled by create-next-app
  - Tailwind v4 uses `@tailwindcss/postcss` plugin (not the classic postcss config)
---

## 2026-02-22 - US-003
- Implemented musical scale definitions (major, minor, dorian) in `src/lib/music/scales.ts`
- Created `getNoteName()` helper function that maps root note + scale + index + octave to a note name (e.g. "C4")
- Set up Vitest test runner with path alias support (`vitest.config.ts`)
- Added `test` and `typecheck` scripts to package.json
- 14 unit tests covering all three scales, octave wrapping, sharps, negative indices, and error cases
- Files changed: `src/lib/music/scales.ts`, `src/lib/music/scales.test.ts`, `vitest.config.ts`, `package.json`
- **Learnings for future iterations:**
  - Vitest works out of the box with TypeScript, just needs path alias config in `vitest.config.ts`
  - Scale index wrapping needs modular arithmetic that handles negative values: `((n % len) + len) % len`
  - Music module lives at `src/lib/music/` — scales, synths, mapping, motifs, engine will all go here
---

## 2026-02-22 - US-005
- Implemented commit-to-musical-parameters mapping in `src/lib/music/mapping.ts`
- Pure functions for each mapping: `mapDiffToPitch`, `mapDiffToDuration`, `mapFilesToVelocity`, `mapFilesToOctave`, `mapCIStatusToScale`, `mapTimeToEffects`
- `commitToMusicalParams(commit)` composes all individual mappers into a complete `MusicalParams` object
- Pan is set to 0 (author-specific pan handled by motif system in US-006)
- 40 unit tests covering all individual mappers and the composite function, including edge cases (zero additions, massive diffs, all CI statuses, merge commits, late night commits)
- Files changed: `src/lib/music/mapping.ts`, `src/lib/music/mapping.test.ts`
- **Learnings for future iterations:**
  - 50 additions / 30 = floor(1.67) = 1, so scaleIndex=1 in major scale gives D (interval 2 semitones), not E
  - `getNoteName("C", "major", 1, 3)` returns "D3" — always verify note calculations manually
  - The mapping module depends on `scales.ts` (for `getNoteName`) and `synths.ts` (for `getSynthConfig`) — these must exist first
  - Merge commit detection uses `message.toLowerCase().startsWith("merge ")` — simple but covers standard GitHub merge messages
---

## 2026-02-22 - US-006
- Created deterministic hash utilities in `src/lib/utils/hash.ts` using djb2 hash function
  - `djb2Hash(str)` — produces 32-bit unsigned integer
  - `hashToRange(str, min, max)` — maps string to a float in [min, max]
  - `hashToColor(str)` — maps string to hex color (e.g. "#a3f2c1")
  - `hashToRhythmPattern(str)` — maps string to array of 3-6 relative durations (0.5, 1, 1.5)
- Created author motif generation in `src/lib/music/motifs.ts`
  - `generateAuthorMotif(login)` returns `AuthorMotif` with pan position, rhythm pattern, and color
  - `hashToPanPosition(login)` maps login to stereo position in [-0.8, 0.8]
- 27 unit tests across `hash.test.ts` (16 tests) and `motifs.test.ts` (11 tests) verifying determinism, value ranges, and correctness
- Files changed: `src/lib/utils/hash.ts`, `src/lib/utils/hash.test.ts`, `src/lib/music/motifs.ts`, `src/lib/music/motifs.test.ts`
- **Learnings for future iterations:**
  - Utility modules go in `src/lib/utils/` (first file created here)
  - djb2 hash is simple, fast, and sufficient for deterministic mapping without external deps
  - Use `>>> 0` to ensure unsigned 32-bit integers in JavaScript bitwise operations
  - Linear congruential generator (`seed * 1103515245 + 12345`) works well for deterministic pseudo-random sequences from a single seed
---

## 2026-02-22 - US-008
- Added sequential playback to MusicEngine in `src/lib/music/engine.ts`
  - `play(commits, startIndex?)` — begins sequential playback using setTimeout scheduling
  - `pause()` / `resume()` — stop and continue from current position
  - `stop()` — halt and reset to beginning
  - `seekTo(index)` — jump to specific commit in the sequence
  - `setTempo(secondsBetweenNotes)` — adjusts playback speed (0.3s to 5.0s range)
  - Callbacks: `onNotePlay`, `onPlaybackComplete`, `onError`
  - State accessors: `playing`, `paused`, `currentIndex`, `currentCommit`, `commitCount`, `tempo`
- 29 unit tests in `src/lib/music/engine.test.ts` covering play, pause, resume, stop, seekTo, setTempo, callbacks, state accessors, and dispose
- Files changed: `src/lib/music/engine.ts`, `src/lib/music/engine.test.ts`
- **Learnings for future iterations:**
  - Mocking Tone.js for tests requires `function` constructors (not arrow functions) — `vi.fn(() => obj)` fails with "not a constructor" when used with `new`
  - `scheduleNext()` plays the current note then increments `_currentIndex` — so after play, `currentIndex` points to the *next* note to be played
  - The `seekTo()` method re-triggers `scheduleNext()` when playing (not paused), so it immediately plays the note at the seeked-to index
  - Exported callback types: `NotePlayCallback`, `PlaybackCompleteCallback`, `ErrorCallback` for consumers
---

## 2026-02-22 - US-009
- Added special sounds to MusicEngine for merge, revert, first-of-day, and CI failure commits
  - **Merge commits**: Layered cymbal/crash via a lazy-created MetalSynth connected to masterVolume
  - **Revert commits**: Temporarily overrides synth envelope to slow attack (70% of duration), sharp release (0.05s), then restores original values
  - **First-of-day**: 3-note ascending arpeggio (scale degrees 0, 2, 4) via a lazy-created Synth, played before the main note
  - **CI failure**: Dissonant grace note one semitone below the main note via a lazy-created Synth
- Added exported helper functions: `isMergeCommit()`, `isRevertCommit()`, `isFirstOfDay()`
- Added private helper `semitoneBelowNote()` for computing grace notes
- Added `_previousCommit` tracking in `scheduleNext()` for first-of-day detection
- Special synths (cymbal, grace, arpeggio) are lazy-created and disposed with the engine
- 18 new tests (47 total in engine.test.ts) covering all special sounds, detection helpers, and timing integrity
- Files changed: `src/lib/music/engine.ts`, `src/lib/music/engine.test.ts`
- **Learnings for future iterations:**
  - Special sound synths use `.connect(masterVolume)` (not `.chain()`) since they bypass the per-language panner/reverb/delay chain
  - Use `getUTCDate()`/`getUTCMonth()`/`getUTCFullYear()` for date comparison to avoid timezone-dependent test failures
  - When testing Tone.js mocks, the same mock constructor (e.g. `Synth`) may be used for both chain synths and special synths — distinguish by checking `.connect` vs `.chain` calls, or by argument patterns (velocity values)
  - Lazy synth creation pattern: check `this.cymbalSynth` for null, create and `.connect()` on first use, dispose in `dispose()`
  - `as unknown as Record<string, unknown>` double-cast needed when accessing envelope properties on ToneInstrument union type
---

## 2026-02-22 - US-010
- Added visualization data tests to `src/lib/music/engine.test.ts` (10 new tests, 57 total in file)
- Verified existing implementation of `getWaveformData()` and `getFFTData()` methods in `src/lib/music/engine.ts`
- Both methods return `Float32Array` from Tone.js Analyser nodes (waveform and FFT)
- Analyser nodes configured with FFT size 2048 in `initialize()`
- Signal chain: masterVolume → waveformAnalyser → fftAnalyser → Destination
- Methods return empty `Float32Array(0)` when engine is not initialized or disposed
- Files changed: `src/lib/music/engine.test.ts`, `.chief/prds/main/prd.json`, `.chief/prds/main/progress.md`
- **Learnings for future iterations:**
  - The visualization data methods (`getWaveformData`, `getFFTData`) were already implemented as part of US-007 engine initialization — US-010 mainly needed test coverage
  - Tone.js mock constructors (e.g. `MockAnalyser`) are plain functions, not `vi.fn()` spies — you can't use `toHaveBeenCalledWith` on them. Test behavior (return values) instead of mock internals
  - `Tone.Volume` mock doesn't have `.mock.instances` since it's a constructor function, not a vi.fn — avoid accessing mock metadata on non-spy constructors
---

## 2026-02-22 - US-011
- Implemented `useMusicEngine` React hook in `src/hooks/useMusicEngine.ts`
  - Exposes state: `isPlaying`, `currentCommit`, `currentIndex`, `progress` (0-1)
  - Exposes controls: `play()`, `pause()`, `resume()`, `stop()`, `seekTo()`, `setTempo()`, `setVolume()`
  - Exposes visualization: `getWaveformData()`, `getFFTData()`
  - `play()` gates initialization behind user gesture (calls `engine.initialize()` on first use)
  - Cleans up engine callbacks on unmount
- Installed `@testing-library/react` and `jsdom` as dev dependencies for React hook testing
- Updated `vitest.config.ts` to include `*.test.tsx` files
- 15 unit tests in `src/hooks/useMusicEngine.test.tsx` covering initial state, all controls, callbacks, cleanup, and single-initialization
- Files changed: `src/hooks/useMusicEngine.ts`, `src/hooks/useMusicEngine.test.tsx`, `vitest.config.ts`, `package.json`, `pnpm-lock.yaml`
- **Learnings for future iterations:**
  - React hook tests use `@testing-library/react` with `renderHook` and `act` — need `jsdom` environment (set via `// @vitest-environment jsdom` comment)
  - The `useMusicEngine` hook wraps the MusicEngine singleton — it sets callbacks in a `useEffect` and clears them on unmount
  - `play()` is async in the hook (calls `ensureInitialized()`) even though `engine.play()` is sync — this gates audio context init behind user gesture
  - The engine's `onNotePlay` fires synchronously within `scheduleNext()` during `play()`, so state updates happen within the same `act()` block
  - Progress formula: `currentIndex / (commitCount - 1)` gives 0-1 range; returns 0 when commitCount is 0
---

## 2026-02-22 - US-012
- Implemented `WaveformVisualizer` component in `src/components/player/WaveformVisualizer.tsx`
  - Full-width canvas, 140px tall (`h-[140px] w-full`)
  - Real-time waveform drawing from `getWaveformData()` using `requestAnimationFrame`
  - Stroke color transitions smoothly to match current commit's language color via lerp
  - Subtle mirror/reflection effect below centerline at 0.2 opacity (0.1 when idle)
  - Idle/stopped state shows slow sine wave "heartbeat" animation (amplitude 8px, 4 cycles across width)
  - Canvas resizes responsively using `getBoundingClientRect` + `devicePixelRatio` for high-DPI
- Language color map defined inline: Python→#3572A5, JavaScript→#f1e05a, TypeScript→#3178c6, etc.
- Default stroke color is `#00ffc8` (cyan accent matching project design spec)
- 12 unit tests in `WaveformVisualizer.test.tsx` covering rendering, animation lifecycle, idle/playing states, mirror effect, language color transitions, empty data handling
- Files changed: `src/components/player/WaveformVisualizer.tsx`, `src/components/player/WaveformVisualizer.test.tsx`
- **Learnings for future iterations:**
  - This is the first component in `src/components/player/` — directory needed to be created
  - Canvas rendering tests require mocking `HTMLCanvasElement.prototype.getContext`, `getBoundingClientRect`, `requestAnimationFrame`, and `cancelAnimationFrame`
  - Color lerp is done in RGB space for simplicity (parsing hex → interpolating → outputting `rgb()` string)
  - The component takes `getWaveformData`, `isPlaying`, and optional `currentLanguage` as props (not using `useMusicEngine` directly — keeps it decoupled)
  - Language colors are defined in the component; may be extracted to a shared module later when other components need them
---

## 2026-02-22 - US-013
- Implemented `TransportControls` component in `src/components/player/TransportControls.tsx`
  - Play/Pause toggle button — shows Play icon when stopped, Pause icon when playing
  - Stop button — resets playback to beginning
  - Skip backward / Skip forward buttons — disabled at sequence boundaries
  - Tempo slider (0.3s to 5.0s) with numeric display showing value with one decimal
  - Volume slider (0-100%) with mute toggle that remembers pre-mute volume
  - Progress bar showing current position in commit sequence, clickable to seek
  - Commit counter display (e.g. "4 / 10")
- Component is decoupled from `useMusicEngine` — takes callback props for all actions
- 24 unit tests in `TransportControls.test.tsx` covering all buttons, sliders, mute/unmute, progress bar seeking, disabled states, and initial values
- Files changed: `src/components/player/TransportControls.tsx`, `src/components/player/TransportControls.test.tsx`
- **Learnings for future iterations:**
  - `@testing-library/react` needs explicit `cleanup()` in `afterEach` when using `// @vitest-environment jsdom` — without it, multiple renders accumulate in the DOM and `getByLabelText` finds duplicate elements
  - SVG icons are inline (no icon library) — keeps dependencies minimal and bundle small
  - Progress bar uses `role="progressbar"` with aria attributes for accessibility, and `getBoundingClientRect` + `clientX` for click-to-seek calculation
  - Mute toggle stores pre-mute volume in a `useRef` to restore on unmute
  - Component follows same prop-based pattern as `WaveformVisualizer` — decoupled from `useMusicEngine` for testability and reuse
---

## 2026-02-22 - US-014
- Created test page at `/` that plays through hardcoded sample commits with full audio engine integration
- Created `src/lib/data/sample-commits.ts` with 12 hardcoded commits spanning:
  - 7 languages: TypeScript, Python, JavaScript, Rust, Markdown, Shell, Go, Java, C++, CSS, Ruby
  - 5 authors: alice, bob, carol, dave, eve
  - CI statuses: pass, fail, pending, unknown
  - Special commits: merge ("Merge pull request #42"), revert ("Revert ..."), first-of-day (March 11 commits), late-night (23:50)
- Musical params computed dynamically via `commitToMusicalParams()` to stay consistent with mapping logic
- Created `src/components/player/TestPlayer.tsx` client component integrating:
  - `WaveformVisualizer` with language-based stroke color
  - `TransportControls` with all functional controls (play, pause, stop, seek, tempo, volume)
  - Now-playing card showing author, message, language, diff stats, CI status, and musical info
  - Scrollable commit list with clickable items for seeking
- Updated `src/app/page.tsx` to render the test page (replaced default Next.js scaffold)
- Files changed: `src/app/page.tsx`, `src/components/player/TestPlayer.tsx`, `src/lib/data/sample-commits.ts`
- **Learnings for future iterations:**
  - Sample commits use `Omit<Commit, "musicalParams">` and compute params dynamically — keeps data in sync with any mapping logic changes
  - The `TestPlayer` component manages play/resume/stop state via a `hasStartedRef` ref — first play calls `play()`, subsequent calls use `resume()`
  - Language colors are duplicated between `WaveformVisualizer` and `TestPlayer` — may want to extract to a shared module
  - `&minus;` HTML entity works in JSX for the minus sign in diff stats display
---

## 2026-02-22 - US-015
- Set up SQLite database with better-sqlite3 in `src/lib/db/`
- Database connection module (`index.ts`) with singleton pattern, WAL mode, foreign keys ON
- Schema creation (`schema.ts`) with repos, commits, user_settings tables and required indexes (idx_commits_repo_time, idx_commits_author)
- CRUD for repos (`repos.ts`): create, getById, getByFullName, getAll, update (dynamic fields), delete
- CRUD for commits (`commits.ts`): create, createMany (transactional batch), getById, getByRepo (with pagination + date range filtering), getByAuthor, deleteByRepo
- CRUD for settings (`settings.ts`): get (returns defaults for new users), save (upsert via ON CONFLICT), delete
- JSON columns (languages, musical_params, instrument_overrides, etc.) serialized as TEXT
- 32 unit tests in `db.test.ts` covering all CRUD operations, schema creation, cascading deletes, pagination, date filtering, upserts, and defaults
- Added `pnpm.onlyBuiltDependencies` to package.json for better-sqlite3 native addon
- Files changed: `package.json`, `pnpm-lock.yaml`, `src/lib/db/index.ts`, `src/lib/db/schema.ts`, `src/lib/db/repos.ts`, `src/lib/db/commits.ts`, `src/lib/db/settings.ts`, `src/lib/db/db.test.ts`
- **Learnings for future iterations:**
  - better-sqlite3 requires native build — use `pnpm.onlyBuiltDependencies` in package.json (not .npmrc)
  - `pnpm approve-builds` is interactive and doesn't work in non-interactive terminals — use package.json config instead
  - In-memory SQLite (`:memory:`) is ideal for tests — fast, isolated, no cleanup needed
  - `vi.mock("./index")` with a module-level `let db` variable lets tests inject their own database instance
  - SQLite `INSERT OR REPLACE` is useful for commit upserts (same SHA can be re-fetched with updated CI status)
  - Foreign keys need `PRAGMA foreign_keys = ON` each connection (SQLite default is OFF)
  - SQLite stores dates as TEXT — ISO 8601 strings sort correctly for range queries
---

## 2026-02-22 - US-016
- Configured NextAuth.js v5 (beta.30) with GitHub OAuth provider
- Auth config in `src/lib/auth.ts` with GitHub provider, `repo` and `read:org` scopes
- JWT and session callbacks store GitHub access token in encrypted session
- Route handler at `src/app/api/auth/[...nextauth]/route.ts` exports GET/POST handlers
- Type augmentation in `src/types/next-auth.d.ts` extends Session and JWT with `accessToken`
- `AuthButton` client component in `src/components/shared/AuthButton.tsx` shows sign in/out state
- `Providers` wrapper component in `src/components/shared/Providers.tsx` with `SessionProvider`
- Updated `src/app/layout.tsx` to wrap children with `Providers`
- Fixed pre-existing lint errors: WaveformVisualizer self-referencing useCallback (used drawRef pattern), unused imports in mapping.ts/mapping.test.ts
- Files changed: `package.json`, `pnpm-lock.yaml`, `src/lib/auth.ts`, `src/types/next-auth.d.ts`, `src/app/api/auth/[...nextauth]/route.ts`, `src/components/shared/AuthButton.tsx`, `src/components/shared/Providers.tsx`, `src/app/layout.tsx`, `src/components/player/WaveformVisualizer.tsx`, `src/lib/music/mapping.ts`, `src/lib/music/mapping.test.ts`
- **Learnings for future iterations:**
  - NextAuth.js v5 beta works with Next.js 16 — install via `pnpm add next-auth@beta`
  - Auth config goes in `src/lib/auth.ts` (not root `auth.ts`) to match project's file structure
  - Export `{ auth, handlers, signIn, signOut }` from NextAuth() — `handlers` is destructured to `{ GET, POST }` in route handler
  - Use existing env var names from `.env.example` (GITHUB_CLIENT_ID, GITHUB_CLIENT_SECRET, NEXTAUTH_SECRET) — pass explicitly to provider config
  - Session augmentation requires `declare module "next-auth"` and `declare module "next-auth/jwt"` in a `.d.ts` file
  - Client components using `useSession` need `SessionProvider` in a parent — use a `Providers` wrapper component in `src/components/shared/Providers.tsx`
  - Self-referencing `useCallback` for animation loops triggers lint error — use `drawRef` pattern: store draw function in a ref, update ref in useEffect, self-reference via `drawRef.current`
---

## 2026-02-22 - US-017
- Implemented file extension to language detection in `src/lib/github/languages.ts`
  - `EXTENSION_LANGUAGE_MAP`: maps 40+ file extensions to language names matching `LANGUAGE_SYNTH_MAP` keys
  - `getLanguageForFile(filePath)`: extracts extension from path and returns language name ("Other" for unknown)
  - `computeLanguageCounts(files)`: aggregates line counts per language from a list of changed files
  - `getPrimaryLanguage(files)`: returns the language with the most lines changed
  - `FileChange` interface: `{ filename: string, changes?: number }` for use by GitHub commit processing
- 34 unit tests in `src/lib/github/languages.test.ts` covering all extensions, path handling, case insensitivity, dotfiles, multi-dot filenames, empty inputs, ties, and real-world scenarios
- Files changed: `src/lib/github/languages.ts`, `src/lib/github/languages.test.ts`
- **Learnings for future iterations:**
  - First file in `src/lib/github/` — this is where GitHub API integration modules live
  - Language names must exactly match keys in `LANGUAGE_SYNTH_MAP` from `src/lib/music/synths.ts` (e.g. "C++", not "Cpp")
  - `FileChange` interface uses optional `changes` field — when absent, counts by file (1 per file) instead of by lines
  - Extension extraction uses `lastIndexOf(".")` to handle multi-dot filenames like `app.test.ts`
  - Files without dots (Makefile, LICENSE, Dockerfile) return "Other"
---

## 2026-02-22 - US-018
- Implemented Octokit wrapper in `src/lib/github/client.ts` — simple factory function that creates authenticated Octokit client
- Implemented commit fetching and processing in `src/lib/github/commits.ts`:
  - `fetchCommits(octokit, options)` — fetches commits from GitHub with pagination, processes each one
  - Fetches commit list via `repos.listCommits` with since/until/page/perPage params
  - Fetches full commit details via `repos.getCommit` for diff stats and changed files
  - Applies language detection from changed files using `getPrimaryLanguage`/`computeLanguageCounts`
  - Computes and attaches musical parameters via `commitToMusicalParams`
  - Returns `{ commits, hasMore, rateLimitRemaining }`
  - `hasMore` determined by whether response length equals perPage
  - Rate limit parsed from `x-ratelimit-remaining` response header
- Installed `octokit` package (v5.0.5) as a dependency
- 16 unit tests in `commits.test.ts` covering: API parameter passing, commit detail fetching, field mapping, language detection, musical params, author fallback, pagination (hasMore), rate limits, empty results, missing stats/files, multi-commit ordering, merge commit effects
- Files changed: `package.json`, `pnpm-lock.yaml`, `src/lib/github/client.ts`, `src/lib/github/commits.ts`, `src/lib/github/commits.test.ts`
- **Learnings for future iterations:**
  - Octokit types are complex — use `mock as unknown as Parameters<typeof fetchCommits>[0]` for test mocks
  - GitHub commit list API returns minimal data; full details (stats, files) require a separate `getCommit` call per SHA
  - `author.login` can be null on GitHub (e.g., commits from non-GitHub users) — fall back to `commit.author.name`
  - CI status is set to "unknown" here — US-019 will add proper CI status fetching
  - Rate limit header key is `x-ratelimit-remaining` (lowercase in Octokit response headers)
---

## 2026-02-22 - US-019
- Implemented CI status fetching module at `src/lib/github/ci-status.ts`
  - `fetchCIStatus(octokit, owner, repo, sha)` — fetches check runs via `checks.listForRef` API
  - Maps check run conclusions to CIStatus: failure/timed_out/cancelled → "fail", all success → "pass", queued/in_progress → "pending", no checks → "unknown"
  - Failure takes priority over pending (checked first)
- Integrated into commit fetching pipeline (`src/lib/github/commits.ts`):
  - `fetchCommits` now calls `fetchCIStatus` for each commit instead of hardcoding `"unknown"`
  - Musical parameters are computed after CI status is set, so scale selection (major/minor/dorian) reflects actual CI state
- 11 unit tests in `ci-status.test.ts` covering: API params, no checks, all success, failure, timed_out, cancelled, in_progress, queued, failure priority over pending, skipped, single success
- 1 new integration test in `commits.test.ts` verifying `fetchCIStatus` is called with correct params and result is used
- Files changed: `src/lib/github/ci-status.ts`, `src/lib/github/ci-status.test.ts`, `src/lib/github/commits.ts`, `src/lib/github/commits.test.ts`
- **Learnings for future iterations:**
  - GitHub Check Runs API: `checks.listForRef` returns `{ check_runs: [...] }` — check `conclusion` for completed runs, `status` for in-progress
  - Check run conclusions include: success, failure, neutral, cancelled, skipped, timed_out, action_required, stale
  - When mocking a module that another module imports, use `vi.mock("./ci-status")` at the module level and `vi.mocked()` to type the mock
  - Failure should be checked before pending — if any check failed, the overall status is "fail" regardless of other running checks
---

## 2026-02-22 - US-020
- Implemented commit caching layer in `src/lib/github/cache.ts`
  - `isCacheStale(lastFetchedAt, queryTo?)` — determines cache freshness based on staleness rules
  - `getCachedCommits(octokit, options)` — checks SQLite cache first, falls back to GitHub fetch
  - Cache freshness rules: 5-minute TTL for recent data (within 24h), permanent cache for historical data (older than 24h)
  - On cache miss: fetches all pages from GitHub, stores commits in SQLite, updates `last_fetched_at` on repo
  - On cache hit: reads directly from SQLite with pagination and date range filtering
  - Ensures repo exists in DB (creates if needed) before storing commits
  - Returns `{ commits, total, page, hasMore, fromCache }` result
- 18 unit tests in `cache.test.ts` covering:
  - `isCacheStale`: null fetch time, fresh/stale recent data, historical data permanence, boundary conditions (exactly 5 min)
  - `getCachedCommits`: cache hit, cache miss, stale cache, historical query bypass, multi-page GitHub fetch, date range passthrough, empty results, hasMore computation, page/limit passthrough
- Files changed: `src/lib/github/cache.ts`, `src/lib/github/cache.test.ts`
- **Learnings for future iterations:**
  - The caching layer sits between the API route (US-022) and the GitHub fetch module — API routes should call `getCachedCommits` instead of `fetchCommits` directly
  - `getRepoByFullName` returns `undefined` (not `null`) when repo not found — check with `=== undefined` or truthiness
  - For mocking both DB and GitHub modules, use `vi.mock("../db/commits")` and `vi.mock("./commits")` separately — each gets its own mock factory
  - `last_fetched_at` is stored as ISO 8601 string on the repos table — already existed in schema from US-015
  - When fetching from GitHub on cache miss, all pages are fetched (not just the requested page) to fully populate the cache
---

## 2026-02-22 - US-021
- Implemented GET /api/repos route at `src/app/api/repos/route.ts`
  - Authenticates via `auth()` from NextAuth — returns 401 if no session or missing accessToken
  - Creates Octokit client with session access token
  - Fetches user's repos via `repos.listForAuthenticatedUser` sorted by `pushed` (desc), 100 per page
  - Maps response to `{ fullName, description, language, pushedAt }` format
  - Graceful error handling: preserves Octokit error status codes, returns 500 for unknown errors
- 7 unit tests in `src/app/api/repos/route.test.ts` covering: unauthenticated (null session, missing token), repo listing, token passthrough, empty repos, Octokit errors, unknown errors
- Files changed: `src/app/api/repos/route.ts`, `src/app/api/repos/route.test.ts`
- **Learnings for future iterations:**
  - NextAuth v5 `auth()` has overloaded types (middleware, route handler, standalone) — in tests, create a separate `vi.fn<() => Promise<Session | null>>()` and wire it through the mock factory to avoid type conflicts
  - API route tests: mock `@/lib/auth` and `@/lib/github/client` at module level with `vi.mock()`, then use `vi.mocked()` or separate fn variables for type-safe mock control
  - Cast mock session objects with `as Session` (import `Session` from `next-auth`) rather than complex conditional types
  - Octokit error objects have a `status` property — check `"status" in error` to extract HTTP status for forwarding
---

## 2026-02-22 - US-022
- Implemented GET /api/commits route at `src/app/api/commits/route.ts`
  - Authenticates via `auth()` from NextAuth — returns 401 if no session or missing accessToken
  - Required query param: `repo` (owner/repo format) — returns 400 if missing or invalid format
  - Optional query params: `from` (ISO date), `to` (ISO date), `page` (default 1), `limit` (default 100, max 100)
  - Validates page (>= 1) and limit (1-100) parameters — returns 400 on invalid values
  - Delegates to `getCachedCommits()` from cache layer (US-020) for cache-first fetching
  - Response format: `{ commits, total, page, hasMore }` — does not expose internal `fromCache` field
  - Graceful error handling: preserves error status codes from Octokit/cache layer, returns 500 for unknown errors
- 17 unit tests in `src/app/api/commits/route.test.ts` covering: auth (null session, missing token), missing repo, invalid repo format, invalid page/limit, default pagination, param passthrough, token passthrough, empty results, hasMore, error handling (Octokit errors, unknown errors)
- Files changed: `src/app/api/commits/route.ts`, `src/app/api/commits/route.test.ts`
- **Learnings for future iterations:**
  - API route tests for routes with query params: create `NextRequest` with `new NextRequest(new URL(url, "http://localhost:3000"))` — the URL base is required
  - The `getCachedCommits` result includes `fromCache` which is an internal detail — the API route should strip it from the response
  - Following same auth pattern as repos route: `auth()` → check `session?.accessToken` → 401 if missing
  - Following same error handling pattern: check `error instanceof Error` for message, check `"status" in error` for HTTP status code forwarding
---

## 2026-02-22 - US-023
- Implemented GET/PUT /api/settings route at `src/app/api/settings/route.ts`
  - **GET**: Returns current user's settings (defaults if none saved) — response format `{ settings: UserSettings }`
  - **PUT**: Accepts JSON body, merges with existing settings, saves to SQLite — response format `{ settings: UserSettings }`
  - Both endpoints require auth (401 if not signed in), identify user by `session.user.email`
  - PUT validates JSON body (400 for invalid JSON, non-object), handles partial updates by merging with current settings
  - PUT overrides `userId` from session (ignores any userId in request body) — prevents impersonation
  - Default settings for new users: tempo 1.0, volume 0.8, theme "dark"
  - Graceful error handling for database errors (500)
- 16 unit tests in `src/app/api/settings/route.test.ts` covering: auth (null session, missing token, no email), GET defaults, GET saved settings, GET errors, PUT auth, PUT invalid JSON, PUT non-object body, PUT full save, PUT partial merge, PUT userId override, PUT errors (Error, non-Error)
- Files changed: `src/app/api/settings/route.ts`, `src/app/api/settings/route.test.ts`
- **Learnings for future iterations:**
  - Settings route uses `session.user?.email` as userId — consistent unique identifier from GitHub OAuth
  - PUT merges body with existing settings before saving — allows partial updates (e.g. just changing theme)
  - `userId` is always overridden from session after merge — `{ ...current, ...body, userId }` ensures body can't override userId
  - Test helper pattern: `makeSession()` and `makePutRequest()` reduce boilerplate across test cases
  - Mock pattern for DB modules: use separate `vi.fn()` variables wired through mock factory (same pattern as auth mock)
---

## 2026-02-22 - US-024
- Implemented `useCommits` React hook in `src/hooks/useCommits.ts`
  - Accepts `{ repo, from?, to?, limit? }` params
  - Returns `{ commits, isLoading, error, hasMore, loadMore }`
  - Fetches from `/api/commits` with proper query params
  - Aborts in-flight requests when params change (AbortController)
  - `loadMore()` appends next page commits; no-ops when loading or no more pages
  - Resets commits when repo changes to null
  - Refetches page 1 (replacing existing commits) when repo/from/to/limit change
  - Graceful error handling: API errors, network failures, non-JSON responses
- 16 unit tests in `src/hooks/useCommits.test.tsx` covering:
  - Initial state, no-fetch when repo null, successful fetch, query param passing
  - Error handling (API errors, network errors, non-JSON errors)
  - Pagination: loadMore appends, loadMore no-op when hasMore=false or isLoading
  - Refetching: repo change, date range change, repo→null reset
  - Replaces (not appends) commits on param change
  - Default limit of 100
- Files changed: `src/hooks/useCommits.ts`, `src/hooks/useCommits.test.tsx`
- **Learnings for future iterations:**
  - Hook tests that use `fetch` mock: use `globalThis.fetch = vi.fn()` pattern, restore original in `afterEach`
  - Use `waitFor` from `@testing-library/react` for async state updates instead of manual `act` + sleep
  - `vi.useFakeTimers({ shouldAdvanceTime: true })` needed when testing hooks with async operations and AbortController
  - `URLSearchParams` encodes `/` as `%2F` and `:` as `%3A` — test assertions need encoded values
  - AbortController abort in useEffect cleanup prevents state updates on unmounted/stale renders
---

## 2026-02-22 - US-025
- Implemented unauthenticated landing page at `/` with server-side auth check
- Created `src/components/landing/LandingPage.tsx` client component with:
  - Hero section: title, description explaining the concept, GitHub icon + "Connect with GitHub" CTA button
  - Embedded demo player using the existing `TestPlayer` component with hardcoded sample commits
  - Dark theme aesthetic: near-black background (#0a0a0e), cyan/teal accent (#00ffc8)
- Updated `src/app/layout.tsx`:
  - Replaced Geist/Geist_Mono fonts with JetBrains Mono (code/data) and Space Grotesk (headings)
  - Updated metadata title/description
- Updated `src/app/globals.css`:
  - Set `--font-sans` to Space Grotesk, `--font-mono` to JetBrains Mono
  - Removed light/dark media query — always dark (#0a0a0e background)
- Updated `src/app/page.tsx` to a server component that calls `auth()` and conditionally renders:
  - Unauthenticated: `<LandingPage />` with hero + demo player
  - Authenticated: existing TestPlayer (placeholder for US-026 dashboard)
- Files changed: `src/app/page.tsx`, `src/app/layout.tsx`, `src/app/globals.css`, `src/components/landing/LandingPage.tsx`
- **Learnings for future iterations:**
  - `auth()` from NextAuth v5 can be called in server components to gate content by auth state
  - Font variables use `--font-jetbrains-mono` and `--font-space-grotesk` — apply via `font-[family-name:var(--font-jetbrains-mono)]` in Tailwind classes or `font-mono`/`font-sans` via theme config
  - The landing page is a client component (needs `signIn` from next-auth/react) but the page route is a server component — this hybrid pattern works because the client component is imported and rendered by the server component
  - `LandingPage` reuses `TestPlayer` as the demo player — no duplication of sample commit data or player logic
---

## 2026-02-28 - US-026
- Implemented authenticated dashboard at `/` with three new components in `src/components/dashboard/`:
  - **RepoSelector** (`RepoSelector.tsx`): Dropdown populated from `/api/repos` with loading and error states
  - **DateRangePicker** (`DateRangePicker.tsx`): Preset buttons (Today, This Week, This Sprint, Custom) with custom date range inputs
  - **Dashboard** (`Dashboard.tsx`): Main dashboard component with repo selector, date range picker, "Play Soundtrack" button, and recent sessions list
- "Play" button navigates to `/play/[owner]/[repo]?range=...&from=...&to=...`
- Recent sessions stored in localStorage (last 5 played soundtracks with repo, preset, and time ago display)
- Date range computation: today (midnight to now), week (Monday to now), sprint (14 days ago to now), custom (user-specified dates)
- Updated `src/app/page.tsx` to render `<Dashboard />` for authenticated users (replacing TestPlayer placeholder)
- Fixed lint error: replaced `useEffect` + `setState` for loading localStorage with `useState` initializer function
- Files changed: `src/components/dashboard/Dashboard.tsx`, `src/components/dashboard/DateRangePicker.tsx`, `src/components/dashboard/RepoSelector.tsx`, `src/app/page.tsx`, `.chief/prds/main/prd.json`
- **Learnings for future iterations:**
  - React lint rule `react-hooks/set-state-in-effect` forbids calling `setState` synchronously inside `useEffect` — use `useState(initializer)` instead for client-side-only data like localStorage
  - Dashboard components follow same `"use client"` pattern as other UI components in the project
  - Recent sessions use localStorage for simplicity — no API persistence needed for this data
  - `getDateRange()` helper is defined in Dashboard component (not shared utility module) since it's only used here; US-043 will add a shared version later
  - For `select` elements with dark theme, add `className="bg-[#0a0a0e]"` to `<option>` elements for consistent dropdown styling
---

## 2026-02-28 - US-027
- Implemented Player Page at `src/app/play/[owner]/[repo]/page.tsx` — the core player experience
- Route extracts `owner`/`repo` from URL params, reads `from`/`to`/`range` from search params
- Fetches commits via `useCommits` hook on mount with the repo and date range
- Full layout (top to bottom): header bar with back link/repo name/settings gear, waveform visualizer, transport controls, now-playing card, timeline (commit node dots), instrument legend
- Header shows: repo name (colored), commit count, formatted date range, and settings gear icon link
- Loading state: centered spinner with "Loading commits..." text
- Error state: red-tinted card with error message
- Empty state: icon + "No commits found in this time range" + back link
- Now-playing card shows author avatar initial, author login, commit message, language dot, diff stats (+/-), CI badge, musical info
- Timeline shows horizontal scrollable row of commit nodes sized by diff, colored by language, white-bordered when active
- Instrument legend shows active languages from current commits with colored dots
- Playback logic follows same `hasStartedRef` pattern as TestPlayer — first play calls `play()`, subsequent calls use `resume()`
- Files changed: `src/app/play/[owner]/[repo]/page.tsx`
- **Learnings for future iterations:**
  - React `react-hooks/refs` lint rule: cannot assign `ref.current = value` during render — must use `useEffect` to sync state to refs
  - The `commitsRef` pattern (state → ref via useEffect) lets callbacks always access the latest commits without re-creating callbacks on every commits change
  - Player page is a client component (`"use client"`) — uses `useParams` and `useSearchParams` from `next/navigation` for route/query params
  - `useParams<{ owner: string; repo: string }>()` provides typed route params in Next.js App Router dynamic routes
  - Language colors map, CI status display map, and date range formatter are duplicated from TestPlayer — could be extracted to shared module when more components need them
---

## 2026-02-28 - US-028
- Implemented `NowPlaying` component in `src/components/player/NowPlaying.tsx`
  - Displays author avatar (initial) + login, commit message (truncated to 2 lines via `line-clamp-2`)
  - Language icon (colored dot) + language name
  - Diff stats (`+N −M` with green/red coloring)
  - CI status badge with SVG icons (checkmark for pass, X for fail, clock for pending, question mark for unknown)
  - Musical info line showing instrument, note, scale, duration, and pan
  - Subtle entrance animation (`nowPlayingIn` keyframe) triggered by `key={currentCommit.id}` — React remounts the div on commit change
  - Graceful empty state: "Press play to start the soundtrack"
- Integrated NowPlaying into player page (`src/app/play/[owner]/[repo]/page.tsx`) and `TestPlayer.tsx`, replacing inline now-playing card code
- Removed duplicate `CI_STATUS_DISPLAY` from both player page and TestPlayer (NowPlaying handles CI display internally)
- 14 unit tests in `NowPlaying.test.tsx` covering: empty state, author display, commit message, language display, diff stats, all 4 CI statuses, musical info, entrance animation, line-clamp truncation, language color dot, unknown language fallback
- Files changed: `src/components/player/NowPlaying.tsx`, `src/components/player/NowPlaying.test.tsx`, `src/app/play/[owner]/[repo]/page.tsx`, `src/components/player/TestPlayer.tsx`
- **Learnings for future iterations:**
  - React lint `react-hooks/set-state-in-effect` prevents `setState` inside `useEffect` — for animation triggers on prop changes, use React's `key` prop to force remount instead of state-based animation key
  - CI status icons are inline SVGs with distinct shapes: checkmark (pass), X (fail), clock (pending), question mark (unknown) — more expressive than colored dots alone
  - `line-clamp-2` Tailwind class truncates text to 2 lines with ellipsis — preferred over `truncate` (single line) for commit messages
  - NowPlaying is a presentational component (no hooks) — takes `currentCommit: Commit | null` as sole prop, making it easy to test and reuse
---

## 2026-02-28 - US-029
- Implemented `Timeline` component in `src/components/player/Timeline.tsx` using D3.js
  - Horizontal timeline with circular commit nodes sized proportional to diff (min 8px, max 28px)
  - Nodes colored by programming language using `LANGUAGE_COLORS` map
  - Currently playing commit highlighted with 2px solid white border
  - Thin connecting line between nodes (1px, rgba(255,255,255,0.08))
  - Hover tooltip showing author, message, timestamp, and diff stats (+/-)
  - Click on node calls `onSeek(index)` to navigate playback
  - Auto-scrolls container to keep current commit centered during playback
  - Horizontal scrolling via `overflow-x-auto` container
  - Virtualization for >200 commits: tracks visible range via scroll listener, only renders nodes within visible area + buffer
- Installed `d3` and `@types/d3` as dependencies
- 17 unit tests in `Timeline.test.tsx` covering: empty state, SVG rendering, connecting line, node sizing, language colors, current commit highlighting, click-to-seek, hover tooltip, tooltip hide, diff stats in tooltip, unknown language fallback, scroll container, SVG width, auto-scroll, single commit (no line), virtualization (<=200 all rendered, >200 renders subset)
- Integrated Timeline into player page (`src/app/play/[owner]/[repo]/page.tsx`) replacing inline placeholder
- Integrated Timeline into `TestPlayer.tsx` between NowPlaying card and commit list
- Files changed: `src/components/player/Timeline.tsx`, `src/components/player/Timeline.test.tsx`, `src/app/play/[owner]/[repo]/page.tsx`, `src/components/player/TestPlayer.tsx`, `package.json`, `pnpm-lock.yaml`
- **Learnings for future iterations:**
  - D3.js works well with React via refs — use `d3.select(svgRef.current)` in `useEffect`, clear with `svg.selectAll("*").remove()` before re-rendering
  - jsdom doesn't implement `Element.scrollTo` — guard with optional chaining (`el.scrollTo?.()`) in component, mock with `Element.prototype.scrollTo = vi.fn()` in tests
  - Lint warning `react-hooks/exhaustive-deps` triggers for inline tuple/array values in useEffect deps — wrap with `useMemo` to stabilize identity
  - D3 `selectAll().data().join()` pattern handles enter/update/exit automatically — cleaner than manual enter/exit
  - Timeline component is presentational: takes `commits`, `currentCommitId`, and `onSeek` as props (no internal hooks for data fetching)
  - `LANGUAGE_COLORS` map is duplicated across NowPlaying, TestPlayer, Timeline, and player page — consider extracting to shared module in future
---

## 2026-02-28 - US-031
- Created three reusable shared UI components in `src/components/shared/`:
  - **LanguageIcon** (`LanguageIcon.tsx`): Colored dot for programming languages with optional label, custom size, and aria-label for accessibility. Also exports `LANGUAGE_COLORS` as single source of truth
  - **CIBadge** (`CIBadge.tsx`): CI status badge with SVG icons — green checkmark (pass), red X (fail), yellow clock (pending), gray question mark (unknown). Optional label display
  - **DiffStats** (`DiffStats.tsx`): `+N −M` display with green/red coloring for additions/deletions
- Refactored 5 existing components to use shared components and eliminate `LANGUAGE_COLORS` duplication:
  - `NowPlaying.tsx`: Replaced inline language dot, CI icon, and diff stats with `LanguageIcon`, `CIBadge`, `DiffStats`
  - `InstrumentLegend.tsx`: Replaced inline language dot with `LanguageIcon`
  - `WaveformVisualizer.tsx`: Imported `LANGUAGE_COLORS` from shared module
  - `Timeline.tsx`: Imported `LANGUAGE_COLORS` from shared module, replaced inline diff stats in tooltip with `DiffStats`
  - `TestPlayer.tsx`: Replaced inline language dot with `LanguageIcon`
- 23 new unit tests across 3 test files (10 LanguageIcon, 7 CIBadge, 6 DiffStats)
- All 411 tests passing, typecheck clean
- Files changed: `src/components/shared/LanguageIcon.tsx`, `src/components/shared/LanguageIcon.test.tsx`, `src/components/shared/CIBadge.tsx`, `src/components/shared/CIBadge.test.tsx`, `src/components/shared/DiffStats.tsx`, `src/components/shared/DiffStats.test.tsx`, `src/components/player/NowPlaying.tsx`, `src/components/player/InstrumentLegend.tsx`, `src/components/player/WaveformVisualizer.tsx`, `src/components/player/Timeline.tsx`, `src/components/player/TestPlayer.tsx`
- **Learnings for future iterations:**
  - `LANGUAGE_COLORS` is now the single source of truth in `src/components/shared/LanguageIcon.tsx` — import from there, never duplicate
  - Shared components are presentational (no hooks) — makes them easy to test and reuse
  - `querySelector` returns `Element` (no `.style`), cast to `HTMLElement` in tests when checking style properties
  - Extracting shared components also simplified NowPlaying significantly — removed ~50 lines of inline CI icon and display logic
---

## 2026-02-28 - US-032
- Implemented responsive layout across the entire application for desktop (>1024px), tablet (768-1024px), and mobile (<768px)
- **TransportControls**: Controls stack vertically on mobile (playback buttons centered, tempo/volume below), single row on md+. All buttons have `min-h-11` (44px) touch targets on mobile, relaxed to normal sizing on md+
- **NowPlaying**: Added `compact` prop for mobile bottom bar mode — shows author initial, message truncated, language dot, and CI badge in a single row. Full card renders on md+
- **MobileCommitList**: New component (`src/components/player/MobileCommitList.tsx`) — vertical scrolling commit list replacing horizontal Timeline on mobile. Each item has `min-h-11` touch target
- **Player Page**: Three-breakpoint layout:
  - Desktop (lg+): NowPlaying above Timeline (full layout)
  - Tablet (md to lg): Timeline first, NowPlaying stacks below it
  - Mobile (<md): Waveform + transport at top, MobileCommitList replaces Timeline, compact NowPlaying as fixed bottom bar
  - Added `pb-14` bottom padding on mobile to prevent content from being hidden behind fixed bottom bar
- **LandingPage**: Responsive hero text sizing (3xl → 4xl → 5xl), smaller padding on mobile, min-h-11 on CTA button
- **TestPlayer**: Timeline hidden on small screens (<sm), commit list items have min-h-11 touch targets
- **Dashboard**: All interactive elements (Play button, preset buttons, date inputs, repo selector, recent sessions) have `min-h-11` touch targets
- Header links (back arrow, settings gear) have `min-h-11 min-w-11` on mobile with `flex items-center justify-center` for proper centering
- All 411 tests passing, typecheck clean
- Files changed: `src/app/play/[owner]/[repo]/page.tsx`, `src/components/player/TransportControls.tsx`, `src/components/player/NowPlaying.tsx`, `src/components/player/MobileCommitList.tsx` (new), `src/components/player/TestPlayer.tsx`, `src/components/landing/LandingPage.tsx`, `src/components/dashboard/Dashboard.tsx`, `src/components/dashboard/DateRangePicker.tsx`, `src/components/dashboard/RepoSelector.tsx`
- **Learnings for future iterations:**
  - Tailwind `min-h-11` = 44px = Apple's recommended minimum touch target for mobile
  - Use `md:min-h-0 md:min-w-0` to remove min-size constraints on desktop where they're not needed
  - `hidden md:block` / `block md:hidden` pattern cleanly swaps between mobile and desktop variants of the same content
  - For fixed bottom bars on mobile, add equivalent `pb-X` to the main content to prevent overlap
  - NowPlaying `compact` prop keeps component reusable — same component renders full card or bottom bar based on context
  - Three-breakpoint pattern: use `hidden lg:block` for desktop-only, `hidden md:block lg:hidden` for tablet-only, `block md:hidden` for mobile-only
---

## 2026-02-28 - US-035
- Implemented webhook receiver endpoint at `src/app/api/webhook/route.ts`
  - **POST /api/webhook**: receives GitHub webhook payloads for push events
  - Validates `X-Hub-Signature-256` header against stored webhook secret using timing-safe comparison (`timingSafeEqual`)
  - Looks up repo by `full_name` from payload to retrieve the stored webhook secret
  - Parses push event payloads to extract commits from `commits` array
  - Processes each commit: language detection from added/modified/removed file lists, computes musical params via `commitToMusicalParams`
  - CI status defaults to `"unknown"` for webhook-received commits (no API call to fetch check runs)
  - Stores processed commits in SQLite via `createCommits()`
  - Responds to `ping` events with `{ message: "pong" }`
  - Ignores non-push/non-ping events gracefully (returns 200)
  - Returns 200 on success, 401 on invalid/missing signature, 400 on malformed payload
- 18 unit tests in `route.test.ts` covering: empty body, invalid JSON, malformed payload, unregistered repo, missing secret, missing signature header, invalid signature, wrong secret, ping event, ignored events, push processing, commit field mapping, musical params computation, language detection, no commits, multiple commits, author fallback, repo lookup
- Files changed: `src/app/api/webhook/route.ts`, `src/app/api/webhook/route.test.ts`
- **Learnings for future iterations:**
  - Webhook signature verification uses `crypto.createHmac("sha256", secret)` + `timingSafeEqual` — the `try/catch` around `timingSafeEqual` handles buffer length mismatches (throws if different lengths)
  - Push event payloads have `added`, `removed`, `modified` file arrays per commit (not `files` with `changes` count like the Commits API) — each file counts as 1 change
  - Stats from webhook push events are approximate: `additions = added.length + modified.length`, `deletions = removed.length` — more accurate stats would require fetching commit details from the API
  - DB mock pattern for API route tests: use separate `vi.fn()` variables wired through mock factory, same as auth mock pattern used in other API route tests
  - `request.text()` returns empty string for empty body (not null) — check with `!rawBody` truthiness
---

## 2026-02-28 - US-036
- Implemented Server-Sent Events (SSE) for live commit streaming with three components:
  - **SSE Event Bus** (`src/lib/sse/event-bus.ts`): In-memory pub/sub singleton that routes commits from webhook to SSE clients by repo. Supports subscribe, unsubscribe, broadcast with automatic cleanup of disconnected clients
  - **SSE Endpoint** (`src/app/api/live/route.ts`): `GET /api/live?repo=owner/repo` — authenticated SSE endpoint using `ReadableStream`. Sends `connected` event on open, `commits` events when webhooks arrive, `heartbeat` every 30s. Cleans up on client disconnect via `AbortSignal`
  - **Webhook Integration**: Updated `src/app/api/webhook/route.ts` to import `sseEventBus` and call `broadcast()` after storing commits in SQLite
- 27 new tests:
  - `src/lib/sse/event-bus.test.ts` (18 tests): subscribe, unsubscribe, broadcast, client count, disconnect cleanup, repo isolation, edge cases
  - `src/app/api/live/route.test.ts` (9 tests): auth, param validation, SSE headers, event bus subscription, initial connected event, commit streaming, abort/disconnect cleanup
- Files changed: `src/lib/sse/event-bus.ts` (new), `src/lib/sse/event-bus.test.ts` (new), `src/app/api/live/route.ts` (new), `src/app/api/live/route.test.ts` (new), `src/app/api/webhook/route.ts` (modified)
- **Learnings for future iterations:**
  - SSE in Next.js App Router: use `new ReadableStream()` with `start(controller)` and `TextEncoder` to create `text/event-stream` responses — no special libraries needed
  - SSE format: `event: <name>\ndata: <json>\n\n` — double newline terminates each event
  - Client disconnect detection: use `request.signal.addEventListener("abort", ...)` — Next.js fires abort when SSE client disconnects
  - For singleton testing, use `vi.resetModules()` + dynamic `await import("./module")` in `beforeEach` to get a fresh instance per test
  - The event bus broadcast automatically removes disconnected clients (callback returns false) — no manual cleanup needed
  - ReadableStream `controller.enqueue()` can throw after close — wrap in try/catch and set a `closed` flag
---

## 2026-02-28 - US-037
- Implemented `useLiveCommits` React hook in `src/hooks/useLiveCommits.ts`
  - Accepts `repo: string | null` — no connection when null
  - Establishes SSE connection to `/api/live?repo=...` via `EventSource`
  - Returns `{ latestCommit, isConnected, error }`
  - Listens for `connected` event (sets `isConnected` true), `commits` event (parses JSON, sets `latestCommit` to last commit in batch)
  - Auto-reconnects on disconnect with 3-second delay via `setTimeout`
  - Cleans up EventSource and reconnect timer on unmount
  - Cleans up and creates new connection when repo changes
  - Resets state when repo changes to null
  - Guards against state updates after unmount via `unmountedRef`
- 16 unit tests in `src/hooks/useLiveCommits.test.tsx` covering: initial state (null repo), no EventSource creation for null, correct URL construction, connected event, single commit, multiple commits (last wins), empty commits array, malformed JSON, error/disconnect, auto-reconnect, clear error on reconnect, unmount cleanup, cancel reconnect on unmount, repo change, repo→null cleanup, no state after unmount
- Files changed: `src/hooks/useLiveCommits.ts`, `src/hooks/useLiveCommits.test.tsx`
- **Learnings for future iterations:**
  - EventSource mock requires `function` constructor (not arrow function) — same pattern as Tone.js mocks: `function MockEventSourceConstructor(this: T, url: string) { ... }`
  - `vi.fn().mockImplementation(() => ...)` fails with "is not a constructor" when used with `new` — Vitest detects arrow functions and warns
  - For EventSource mocks, track instances in an external array (`mockEventSourceInstances.push(this)`) instead of using `vi.fn().mock.instances`
  - SSE reconnect pattern: on `onerror`, close the EventSource, set error state, schedule reconnect with `setTimeout`, guard reconnect callback with `unmountedRef`
  - `encodeURIComponent` encodes `/` as `%2F` — test assertions for URL must use encoded form
---

## 2026-02-28 - US-038
- Implemented live mode player page at `src/app/play/[owner]/[repo]/live/page.tsx`
  - Route connects via `useLiveCommits` hook to receive real-time SSE commits
  - Each new commit plays immediately via `useMusicEngine.play()` when received
  - Commits accumulate in a growing timeline (Timeline on md+, MobileCommitList on mobile)
  - "Waiting for commits..." idle state with pulsing animation when connected but no commits yet
  - Connecting state with spinner when SSE connection is being established
  - Pulsing dot indicator + "Live" label in header showing live mode is active
  - Waveform visualizer always visible and active during playback
  - NowPlaying card updates with each new commit (desktop/tablet: full card, mobile: compact bottom bar)
  - Volume control in header for quick access
  - Back link to normal player page (`/play/[owner]/[repo]`), settings gear link
  - Connection error shown in yellow warning banner, with "Reconnecting..." in header subtitle
  - Instrument legend shows active languages from received commits
  - Duplicate commit detection prevents same commit from appearing twice
- Used React "adjust state during render" pattern with `useState` (not refs) to accumulate live commits — avoids both `react-hooks/set-state-in-effect` and `react-hooks/refs` lint errors
- Responsive layout follows same three-breakpoint pattern as normal player page
- 17 unit tests in `page.test.tsx` covering: rendering, live indicator, waiting state, connecting state, error state, waveform, immediate playback, timeline accumulation, multi-commit, deduplication, instrument legend, commit count, reconnecting, repo passthrough, back link, settings link, volume, compact now-playing
- Files changed: `src/app/play/[owner]/[repo]/live/page.tsx` (new), `src/app/play/[owner]/[repo]/live/page.test.tsx` (new), `.chief/prds/main/prd.json`
- **Learnings for future iterations:**
  - React lint `react-hooks/set-state-in-effect`: cannot call `setState` synchronously in `useEffect` body — use "adjust state during render" pattern (check condition using state, not refs, and call `setState` during render)
  - React lint `react-hooks/refs`: cannot read/write `ref.current` during render — use `useState` for tracking previous values during render instead
  - Combined pattern for accumulation: track `prevLatestId` in state, check during render, call `setLiveCommits`, then use a separate `useEffect` (with ref) for side-effects like playing audio
  - Live page doesn't need TransportControls — commits play automatically, no play/pause/stop needed
  - Mock child components in page tests to avoid rendering complexity — use `vi.mock` with simple `data-testid` divs
  - When testing for text that may appear multiple times in DOM (e.g. repo name in header + body), use `getAllByText` instead of `getByText`
---

## 2026-02-28 - US-039
- Extended existing settings page at `/settings` with tempo, volume, and default repository controls
- **Tempo slider**: range input (0.3s to 5.0s, step 0.1) with numeric input for precise entry, clamped to valid range
- **Volume slider**: range input (0-100%, step 1) with percentage display
- **Default repository dropdown**: populated from `/api/repos`, shows loading state, includes "None" option
- **Settings persistence**: loads from `GET /api/settings` on mount, saves via `PUT /api/settings` with Save button
- **Feedback**: "Saving..." disabled state during save, "Settings saved successfully" green text on success (auto-clears after 2s), red error message on failure
- **Loading state**: full-screen "Loading settings..." shown while fetching settings
- Theme section preserved with Dark/Light buttons from US-033
- Also fixed pre-existing lint error in `useLiveCommits.ts`: moved `setState` calls from `useEffect` body to "adjust state during render" pattern with `prevRepo` state tracking
- Files changed: `src/app/settings/page.tsx`, `src/hooks/useLiveCommits.ts`, `.chief/prds/main/prd.json`
- **Learnings for future iterations:**
  - Settings page was already partially built (theme section from US-033) — extended rather than created from scratch
  - Volume stored as 0-1 float in API/DB but displayed as 0-100% in UI — convert with `* 100` / `/ 100`
  - Settings page uses `useEffect` with cancelled flag pattern for both settings and repos loading — same pattern used across the codebase
  - `setTimeout` for auto-clearing save success message: `setTimeout(() => setSaveStatus("idle"), 2000)`
  - Pre-existing `react-hooks/set-state-in-effect` lint errors can be fixed by moving `setState` calls to "adjust state during render" pattern: track previous value in `useState`, compare during render, call `setState` conditionally
---

## 2026-02-28 - US-040
- Implemented `InstrumentMapper` component in `src/components/settings/InstrumentMapper.tsx`
  - Table of language → instrument dropdown for each language in `LANGUAGE_SYNTH_MAP`
  - Each row shows language color dot, language name, synth type dropdown, and Preview button
  - Dropdown options show "(default)" suffix for the default synth type of each language
  - Overridden languages highlighted with accent color in the language name
  - "Preview" button plays a sample C4 note (8n duration) using the selected synth via Tone.js
  - Preview creates a temporary synth, connects to destination, plays note, and disposes after 1 second
  - "Reset to defaults" button clears all overrides (disabled when no overrides)
  - NoiseSynth preview uses `triggerAttackRelease("8n")` (no pitch); MetalSynth and others use `triggerAttackRelease("C4", "8n")`
  - When selecting the default synth type, the override is removed from the map (not stored as an explicit override)
- Integrated InstrumentMapper into settings page (`src/app/settings/page.tsx`):
  - Added `instrumentOverrides` state, loaded from `GET /api/settings` on mount
  - InstrumentMapper rendered between Playback and Default Repository sections
  - `instrumentOverrides` included in `PUT /api/settings` save payload
- 16 unit tests in `InstrumentMapper.test.tsx` covering: row rendering, language names, default synth selection, override display, onChange callbacks (add/remove/preserve), preview button, reset button (disabled/enabled/clear), dropdown options, default suffix, accent highlighting, synth type options, language color dots
- All 505 tests passing, typecheck and lint clean
- Files changed: `src/components/settings/InstrumentMapper.tsx` (new), `src/components/settings/InstrumentMapper.test.tsx` (new), `src/app/settings/page.tsx`
- **Learnings for future iterations:**
  - Settings components go in `src/components/settings/` — first components in this directory
  - `LANGUAGE_SYNTH_MAP` from `src/lib/music/synths.ts` is the canonical list of supported languages — iterate its keys for the instrument mapper rows
  - `SynthType` from `src/lib/music/synths.ts` defines valid synth types — use for dropdown options
  - Instrument overrides stored as `Record<string, string>` (language → SynthType) — only non-default overrides are stored
  - For preview sound, create a temporary synth, connect to destination, play, then dispose after timeout — avoids leaking audio nodes
  - NoiseSynth doesn't accept a pitch note — use `triggerAttackRelease("8n")` without pitch argument
  - Tone.js mock pattern in tests: use `vi.fn().mockImplementation(function Name() { return obj })` — constructor functions (not arrow functions) needed for `new`
---

## 2026-02-28 - US-041
- Implemented `LanguageToggle` component in `src/components/settings/LanguageToggle.tsx`
  - Checklist of all supported languages (from `LANGUAGE_SYNTH_MAP`) with toggle switches
  - Each language row has a styled toggle switch, language color dot, and language name
  - Empty `enabledLanguages` array = all enabled (default); explicit array = only those enabled
  - "Enable all" button resets to empty array (disabled when already all enabled)
  - Muted count indicator shown when languages are disabled
  - Prevents disabling the last remaining language
  - Disabled languages have reduced opacity styling
  - Grid layout: 2 columns on mobile, 3 columns on sm+
- Integrated LanguageToggle into settings page (`src/app/settings/page.tsx`):
  - Added `enabledLanguages` state, loaded from `GET /api/settings` on mount
  - LanguageToggle rendered between Instrument Overrides and Default Repository sections
  - `enabledLanguages` included in `PUT /api/settings` save payload
- Integrated language filtering into playback:
  - Added `_enabledLanguages` field and `setEnabledLanguages()` method to MusicEngine
  - Added `isLanguageEnabled()` private helper
  - `scheduleNext()` skips commits whose `primaryLanguage` is not in the enabled set
  - Exposed `setEnabledLanguages` through `useMusicEngine` hook
  - Player page (`src/app/play/[owner]/[repo]/page.tsx`) loads settings on mount and passes `enabledLanguages` to engine
- 17 unit tests in `LanguageToggle.test.tsx` covering: toggle rendering, all-enabled state, explicit enabled list, disabling from all-enabled, disabling from explicit list, enabling a language, enabling all resets to [], preventing last-language disable, Enable All button states, muted count display, color dots, opacity styling, singular/plural muted text
- All 522 tests passing, typecheck and lint clean
- Files changed: `src/components/settings/LanguageToggle.tsx` (new), `src/components/settings/LanguageToggle.test.tsx` (new), `src/app/settings/page.tsx`, `src/lib/music/engine.ts`, `src/hooks/useMusicEngine.ts`, `src/app/play/[owner]/[repo]/page.tsx`
- **Learnings for future iterations:**
  - `enabledLanguages: string[]` semantics: empty array `[]` = all enabled (default), non-empty = explicit list of enabled languages — consistent with DB default
  - MusicEngine `scheduleNext()` uses a while-loop to skip disabled languages before playing the next note — simple and doesn't affect timing
  - Settings components follow presentational pattern: take state props + onChange callback, no internal data fetching
  - Player page loads user settings via `/api/settings` in a `useEffect` and passes `enabledLanguages` to `setEnabledLanguages` on the engine
  - The LanguageToggle prevents disabling the last language by checking `next.length === 0` after removing — avoids silent playback
---

## 2026-02-28 - US-042
- Implemented `MotifEditor` component in `src/components/settings/MotifEditor.tsx`
  - Lists known authors from connected repos (fetched via new `/api/authors` endpoint)
  - Each author has a color picker (native `<input type="color">`) with hex value display
  - Each author has a rhythm pattern editor with visual beat buttons:
    - Click to cycle through durations: 0.5 (Short/blue), 1 (Normal), 1.5 (Long/orange)
    - Add beat button (+) — max 8 beats
    - Remove beat button (×) on hover — min 2 beats
  - "Preview" button plays the author's rhythmic motif with panned audio using Tone.js
  - Individual "Reset" button per author restores deterministic hash-based motif
  - "Reset all to defaults" button clears all custom motifs
  - "Customized" badge and accent-colored name for authors with custom motifs
  - Pan position displayed for each author
  - Empty state when no authors found ("Play a repository to discover contributors")
- Added `getDistinctAuthors()` function to `src/lib/db/commits.ts` — queries DISTINCT authors from commits table
- Created `GET /api/authors` endpoint at `src/app/api/authors/route.ts` — returns known authors from cached commits (requires auth)
- Integrated MotifEditor into settings page (`src/app/settings/page.tsx`):
  - Added `authorMotifs` and `knownAuthors` state
  - Loads `authorMotifs` from `GET /api/settings` on mount
  - Loads `knownAuthors` from `GET /api/authors` on mount
  - MotifEditor rendered between Language Toggles and Default Repository sections
  - `authorMotifs` included in `PUT /api/settings` save payload
- 24 unit tests in `MotifEditor.test.tsx` covering: empty state, author rows, avatar, default/custom colors, color change, rhythm beats, beat cycling, add/remove beats, max/min beat limits, customized badge, accent highlighting, preview, individual reset, reset all, pan display, preserving other motifs, hex color display
- All 546 tests passing, typecheck clean
- Files changed: `src/components/settings/MotifEditor.tsx` (new), `src/components/settings/MotifEditor.test.tsx` (new), `src/app/settings/page.tsx`, `src/lib/db/commits.ts`, `src/app/api/authors/route.ts` (new)
- **Learnings for future iterations:**
  - Native `<input type="color">` works well for color pickers — no external library needed, dark theme compatible with minimal styling
  - Rhythm pattern editor uses click-to-cycle pattern (0.5 → 1 → 1.5 → 0.5) — simpler than a dropdown per beat
  - Preview plays the full rhythm pattern as ascending notes with pan position applied via Tone.Panner
  - `getDistinctAuthors()` is a simple SQL `SELECT DISTINCT author FROM commits` — efficient since author is indexed (`idx_commits_author`)
  - Known authors come from cached commits, so the user needs to have played at least one repo before authors appear
  - `authorMotifs` in UserSettings is `AuthorMotif[]` (not a Record) — matches the type definition
---

## 2026-02-28 - US-043
- Created `src/lib/utils/time.ts` with `getDateRange()` function and `DatePreset` type
  - `getDateRange(preset, customFrom?, customTo?)` returns `{ from: string, to: string }` in ISO 8601
  - "today" = midnight today (local time) to now
  - "week" = Monday of current week to now
  - "sprint" = 14 days ago (midnight) to now
  - "custom" = uses provided from/to dates (to gets end-of-day T23:59:59)
- Refactored `Dashboard.tsx` to import `getDateRange` from shared utility instead of inline definition
- Updated `DateRangePicker.tsx` to re-export `DatePreset` from `@/lib/utils/time` instead of defining it locally
- 22 unit tests in `src/lib/utils/time.test.ts` covering:
  - "today": midnight to now, ISO format, from < to, midnight edge case
  - "week": Wednesday, Monday-itself, Sunday, Saturday, month boundary crossing, midnight start
  - "sprint": 14 days back, month boundary, year boundary, midnight start
  - "custom": both dates, missing from, empty from, missing to, empty to, end-of-day for to
  - General: all presets return ISO 8601, from <= to for non-custom
- All 568 tests passing, typecheck clean
- Files changed: `src/lib/utils/time.ts` (new), `src/lib/utils/time.test.ts` (new), `src/components/dashboard/Dashboard.tsx`, `src/components/dashboard/DateRangePicker.tsx`, `.chief/prds/main/prd.json`
- **Learnings for future iterations:**
  - `DatePreset` type is now the single source of truth in `src/lib/utils/time.ts` — import from there, re-export from DateRangePicker for backward compatibility
  - `export type { X } from "..."` re-exports a type but does NOT make it available locally — need separate `import type { X }` for local use
  - Dashboard previously had an inline `getDateRange` — now uses the shared module, keeping the function DRY across the codebase
  - Date range utility uses local time for presets (midnight, Monday) — appropriate for user-facing date ranges
---

## 2026-02-28 - US-044
- Implemented consistent error handling and loading states across the entire application
- **Retry on errors**: Added `retry()` function to `useCommits` hook; player page error state now includes "Try again" button; RepoSelector error state includes "Try again" button
- **Empty state for no repos**: RepoSelector shows "No repositories found. Connect a repository to get started." when API returns empty array
- **GitHub rate limit warning**: Plumbed `rateLimitRemaining` from `fetchCommits` → `getCachedCommits` → `/api/commits` → `useCommits` hook → player page; shows yellow warning banner when remaining calls < 100
- **Audio initialization error**: Added `audioError` state to `useMusicEngine` hook; `play()` catches errors from `ensureInitialized()` with user-friendly message for Web Audio failures; error displayed as red banner on player page and live mode page
- **Network error states for live mode**: Enhanced SSE disconnect banner with auto-reconnect explanation; live indicator dot changes to yellow with "Reconnecting" text when disconnected; audio error banner added to live page
- Also fixed pre-existing issues: webhook route `const repo` redeclaration (TS error), missing Pusher mock in webhook tests, duplicate `vi.mock` and missing `act()` wrappers in useLiveCommits tests
- Files changed: `src/hooks/useCommits.ts`, `src/hooks/useMusicEngine.ts`, `src/app/play/[owner]/[repo]/page.tsx`, `src/app/play/[owner]/[repo]/live/page.tsx`, `src/components/dashboard/RepoSelector.tsx`, `src/lib/github/cache.ts`, `src/app/api/commits/route.ts`, `src/app/api/commits/route.test.ts`, `src/app/api/webhook/route.ts`, `src/app/api/webhook/route.test.ts`, `src/hooks/useLiveCommits.test.tsx`
- **Learnings for future iterations:**
  - `rateLimitRemaining` flows: `fetchCommits` (from GitHub headers) → `getCachedCommits` (tracks across pages) → API route → client hook → UI display
  - Cache hits return `rateLimitRemaining: null` since no GitHub API call was made — UI should only show warning when value is non-null and < threshold
  - Audio init errors in `ensureInitialized()` should be caught in the `play()` function and surfaced as state, not just console logged
  - RepoSelector refactored from `useEffect` closure pattern to `useCallback` + `useEffect` for better retry support
  - Pre-existing test failures (Pusher "Options object must provide a cluster") were caused by missing `vi.mock` for `@/lib/pusher/server` — always mock external service clients in tests
  - React hook state updates from external callbacks (Pusher `bind`) must be wrapped in `act()` in tests
---

## 2026-02-28 - US-045
- Implemented demo mode for unauthenticated users on the landing page
- Created `DemoPlayer` component in `src/components/player/DemoPlayer.tsx`:
  - Full playback experience: waveform visualizer, transport controls, now-playing card
  - Simplified — no timeline, no commit list, no settings, no repo selector
  - Prominent "Sign in to play your own repos" CTA with "Connect with GitHub" button
  - Uses hardcoded `SAMPLE_COMMITS` (12 commits across 11 languages, 5 authors, 4 CI statuses)
- Updated `LandingPage.tsx` to use `DemoPlayer` instead of `TestPlayer`
- 10 unit tests in `DemoPlayer.test.tsx` covering: waveform rendering, transport controls, now-playing card, sample commits count, no timeline, no commit list, CTA text, CTA button, signIn callback, no settings/repo selector
- All 551 tests passing, typecheck clean
- Files changed: `src/components/player/DemoPlayer.tsx` (new), `src/components/player/DemoPlayer.test.tsx` (new), `src/components/landing/LandingPage.tsx`
- **Learnings for future iterations:**
  - DemoPlayer is a simplified version of TestPlayer — same playback logic (hasStartedRef pattern) but without timeline, commit list, and with CTA
  - The demo uses the same `SAMPLE_COMMITS` data that TestPlayer uses — no duplication
  - Mock child components (WaveformVisualizer, TransportControls, NowPlaying) in page-level tests for simplicity — test each component individually in its own test file
  - LandingPage now imports DemoPlayer instead of TestPlayer — TestPlayer is still used independently for the /test page if needed
---

## 2026-02-28 - US-046
- Implemented SEO and meta tags across all routes
- **Root layout** (`src/app/layout.tsx`):
  - Enhanced metadata with title template (`%s | Developer Soundtrack`), full description
  - `metadataBase` set from `NEXTAUTH_URL` env var for absolute URL resolution
  - OpenGraph tags: title, description, URL, siteName, type (website)
  - Twitter card tags: `summary_large_image` card type, title, description
- **OG image** (`src/app/opengraph-image.tsx`):
  - Dynamic OG image generated via Next.js `ImageResponse` (edge runtime)
  - 1200x630px image with project branding: dark background (#0a0a0e), waveform bars, title, "Listen to your code" tagline, language color dots
  - Twitter image re-exported from same source (`src/app/twitter-image.tsx`)
- **Settings page** — Added `src/app/settings/layout.tsx` with `title: "Settings"` metadata
- **Player page** — Added `src/app/play/[owner]/[repo]/layout.tsx` with `generateMetadata` using dynamic route params (e.g., "owner/repo Soundtrack")
- **Live page** — Added `src/app/play/[owner]/[repo]/live/layout.tsx` with `generateMetadata` (e.g., "owner/repo Live")
- **Favicon** — Already existed at `src/app/favicon.ico` (kept as-is)
- Files changed: `src/app/layout.tsx`, `src/app/opengraph-image.tsx` (new), `src/app/twitter-image.tsx` (new), `src/app/settings/layout.tsx` (new), `src/app/play/[owner]/[repo]/layout.tsx` (new), `src/app/play/[owner]/[repo]/live/layout.tsx` (new)
- **Learnings for future iterations:**
  - Next.js `opengraph-image.tsx` file convention auto-generates OG image and sets `<meta>` tags — no need to manually specify `images` in metadata when using this approach
  - `twitter-image.tsx` can re-export from `opengraph-image.tsx` to share the same image generation logic
  - Client component pages (`"use client"`) can't export `metadata` — add a `layout.tsx` in the same directory with `generateMetadata` for dynamic routes or `metadata` for static
  - `generateMetadata` in Next.js App Router receives `params` as a `Promise` — must `await params` before accessing route params
  - `metadataBase` should be set from env var (`NEXTAUTH_URL`) to generate correct absolute URLs for OG images in production
  - `.next/dev/types/validator.ts` can get stale — delete `.next/dev/types/` to regenerate when seeing type errors in auto-generated files
---

## 2026-02-28 - US-049
- Implemented large repo handling with four enhancements:
  - **useCommits total**: Added `total` to useCommits return value (parsed from API response) — enables progress display during fetches
  - **Progress indicator**: Loading state shows "Loading X commits..." when total is known (e.g. "Loading 1,204 commits...")
  - **Load more button**: When `hasMore` is true, displays "Load more (X of Y loaded)" button at bottom of player content
  - **Sampling option**: When commits.length > 200, adds "Sample commits" dropdown: All, Every 2nd, Every 5th, Every 10th — reduces played/displayed commits for large ranges
  - Sampling uses `displayCommits = commits.filter((_, i) => i % sampleEvery === 0)` — playback, timeline, and mobile list all use sampled list
  - Stop playback when sample rate changes (avoids index mismatch)
  - Timeline already had virtualization for >200 commits (from US-029); API already paginates (100 per page)
- Files changed: `src/hooks/useCommits.ts`, `src/hooks/useCommits.test.tsx`, `src/app/play/[owner]/[repo]/page.tsx`
- **Learnings for future iterations:**
  - Cache on miss fetches all pages server-side, then returns requested page — client still gets paginated response with total and hasMore
  - Sampling dropdown only shown when commits.length > 200 — keeps UI clean for normal repos
  - `sampleEvery` state reset to 1 when commits drop below 200 (e.g. date range change)
---

## 2026-02-28 - US-050
- Verified and marked US-050 as complete — all acceptance criteria already satisfied by prior iterations:
  - **Scale tests**: `src/lib/music/scales.test.ts` — all three scales, octave wrapping, edge cases
  - **Mapping tests**: `src/lib/music/mapping.test.ts` — commit → musical params, all parameters, determinism, edge cases
  - **Hash/motif tests**: `src/lib/utils/hash.test.ts`, `src/lib/music/motifs.test.ts` — pan, motif, color, determinism
  - **Language tests**: `src/lib/github/languages.test.ts` — file extension → language, edge cases
  - **Date range tests**: `src/lib/utils/time.test.ts` — presets, edge cases
  - Test runner: Vitest, `pnpm test`, CI-compatible
  - 553 tests passing, typecheck clean
- No code changes; prd.json updated to passes: true
- **Learnings for future iterations:**
  - US-050 was effectively completed incrementally as each related user story was implemented
---

## 2026-02-28 - US-047
- Implemented audio export to WAV (stretch goal) with client-side rendering
  - **Export module** (`src/lib/music/export.ts`): Uses Tone.Offline() to render soundtrack faster than real-time; schedules same synth logic as MusicEngine (per-language chains, special sounds for merge/revert/first-of-day/CI-fail); encodes AudioBuffer to WAV format; triggers download
  - **API route** POST `/api/export`: Accepts `{ commitIds: string[] }`, returns `{ commits: Commit[] }` — fetches commits from DB by IDs for shared-link use case (US-048); actual WAV generation is client-side
  - **Export button**: In player page header when commits loaded; shows spinner + "Rendering..." / "Downloading..." during export; uses current tempo/volume from engine (added getTempo/getVolume to engine and useMusicEngine)
  - **getCommitsByIds** added to `src/lib/db/commits.ts` for batch lookup
  - **Exported semitoneBelowNote** from engine for use in export module
- Spec called for server-side rendering via OfflineAudioContext — Web Audio API is browser-only; client-side with Tone.Offline() is the practical approach; API route provides commit fetch for future shared links
- Files changed: `src/lib/music/export.ts` (new), `src/lib/music/engine.ts`, `src/lib/db/commits.ts`, `src/app/api/export/route.ts` (new), `src/app/api/export/route.test.ts` (new), `src/app/play/[owner]/[repo]/page.tsx`, `src/hooks/useMusicEngine.ts`
- **Learnings for future iterations:**
  - Tone.Offline(callback, duration) creates isolated context; all nodes must be created inside callback; scheduling uses absolute time (startTime = i * tempo)
  - WAV encoding: 44-byte header (RIFF, fmt, data chunks) + interleaved 16-bit PCM; AudioBuffer.getChannelData(0/1) for stereo
  - ToneAudioBuffer from Offline may have .get() returning underlying AudioBuffer — check at runtime
---
